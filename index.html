<!DOCTYPE html>
<html>
<head>
	<title>Bring Home the Bacon</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
</head>
<body>
	<div class="container" ng-app="myApp" ng-controller="mainCtrl" ng-cloak>
      <div class="header clearfix">        
        <h3 class="text-muted">Bring Home the Bacon (Users: {{userCount}})</h3>
      </div>

      <div class="jumbotron">
        <h3>{{message}}</h3>
        <ul ng-repeat="item in groceries">
        	<li>{{item.name}}</li>
        </ul>
      </div>      

      <footer class="footer">
        <p>Made with care at inNOVAtion 2016</p>
      </footer>

    </div>
	
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
	<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.3/angular.min.js"></script>	
    <script>		
		var app = angular.module('myApp', []);
		app.controller('mainCtrl', function($scope, $http, $rootScope) {
            var host = location.origin.replace(/^http/, 'ws')    
			var ws = new WebSocket(host);			
			$scope.groceries = [];
			$scope.message = "Awaiting input from Pebble app...";
			$scope.userCount = 0;
			ws.onopen = function(event) {
				console.log("Connected");
				//console.log(event);
			};
			$scope.testVar;
			ws.onmessage = function (event) { 
				console.log(typeof JSON.parse(event.data));
				$rootScope.$apply(function() {
					if(typeof JSON.parse(event.data) == "number") {
						$scope.userCount = event.data;
					} else {
						$scope.message = "Grocery list:";
						$scope.groceries = [];
						
					    angular.forEach(JSON.parse(event.data), function(value, key) {
							var listItem = {name: value}
							$scope.addToList(listItem);
						});	
					}								
				});								
			}
			$scope.addToList = function(item) {
				$scope.groceries.push(item);
			}
		});
    </script>
</body>
</html>